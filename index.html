<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check your QueQ</title>

    <!-- Import Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@500&display=swap" rel="stylesheet">
</head>
<body>
    <img src="IMG_8817.png" alt="Logo" class="logo">

    <h1>ตรวจสอบคิวของคุณ</h1>

    <div class="search-container">
        <input type="tel" id="phoneNumber" placeholder="Enter Phone Number" maxlength="12" oninput="formatPhoneNumber()" />
    </div>

    <div id="result"></div>

    <div class="footer">
        <p>© 2022, maple tree house bkk. All Rights Reserved</p>
        <p>991 Rama I Rd., Pathum Wan, Bangkok 10330</p>
        <div class="contact-links">
            <a href="tel:0651201293" class="contact-icon">
                <img src="phone-icon.png" alt="โทรศัพท์" />
            </a>
            <a href="https://www.facebook.com/mapletreehouse.bkk?mibextid=LQQJ4d" target="_blank" class="social-icon">
                <img src="facebook-icon.png" alt="Facebook" />
            </a>
            <a href="https://bit.ly/45CyCOx" target="_blank" class="social-icon">
                <img src="line-icon.png" alt="LINE" />
            </a>
        </div>
    </div>

    <script>
        function getTodaySheetName() {
            const today = new Date();
            return today.getDate();
        }

        // ฟังก์ชันค้นหาที่จะทำงานเมื่อกรอกหมายเลขครบ
        document.getElementById('phoneNumber').addEventListener('input', function() {
            const phoneNumber = this.value.trim();
            if (phoneNumber.length === 10) { // เมื่อกรอกครบ 10 หลัก
                searchQueue(phoneNumber);
            }
        });

        function searchQueue(phoneNumber) {
            if (phoneNumber === '') {
                document.getElementById('result').innerHTML = '';
                return;
            }

            const todaySheetName = getTodaySheetName();
            const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/1QB1aAJscrQpalDm0n8ljVgiU93LDUV4jhWkEgLVY1xA/values/${todaySheetName}?alt=json&key=AIzaSyDLsePC6HjZfIHA8hnEYVWXlDwE9jELNhw`;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // ตรวจสอบข้อมูลจาก API
                    console.log("API Data:", data);

                    if (!data || !data.values) {
                        throw new Error("Data format is incorrect or empty.");
                    }

                    const rows = data.values;
                    let resultHTML = '';
                    let found = false;
                    let queueStatus = [];
                    let customerData = null;

                    for (let i = 2; i < rows.length; i++) {
                        const row = rows[i];
                        const customerPhone = row[5];
                        const name = row[1];
                        let status = 'รอดำเนินการ';

                        if (row[2] === '1') {
                            status = 'สำเร็จแล้ว';
                        } else if (row[3] === '1') {
                            status = 'ยกเลิก';
                        }

                        if (status === 'รอดำเนินการ') {
                            queueStatus.push({phone: customerPhone, name: name, status: status, rowIndex: i});
                        }

                        if (customerPhone && customerPhone.includes(phoneNumber)) {
                            found = true;
                            customerData = {name: name, phone: customerPhone, status: status};
                        }
                    }

                    if (!found) {
                        alert("ระบบไม่พบ ข้อมูลของท่าน กรุณาติดต่อพนักงานเพื่อขอความช่วยเหลือเพิ่มเติม หรือติดต่อทางหมายเลขโทรศัพท์ 06-512-01293 เพื่อให้เจ้าหน้าที่ของเราดูแลท่านโดยเร็วที่สุด");
                    } else {
                        queueStatus.sort((a, b) => a.rowIndex - b.rowIndex);
                        const queuePosition = queueStatus.findIndex(item => item.phone === customerData.phone) + 1;

                        resultHTML = `
                            <div class="info-box">
                                <div class="row">
                                    <label>คิวของคุณคือ</label>
                                    <div class="value">${queuePosition}</div>
                                </div>
                                <div class="row">
                                    <label>ชื่อ</label>
                                    <div class="value">${customerData.name}</div>
                                </div>
                                <div class="row">
                                    <label>เบอร์</label>
                                    <div class="value">${customerData.phone}</div>
                                </div>
                                <div class="row">
                                    <label>สถานะ</label>
                                    <div class="value">${customerData.status}</div>
                                </div>
                                <!-- เพิ่มคำชี้แจงในกล่องข้อมูล -->
                                <div class="row">
                                    <label>คำชี้แจง</label>
                                    <div class="value">
                            ทางร้านขอเรียนให้ทราบว่า เมื่อถึงคิวของท่านเจ้าหน้าที่ จะทำการติดต่อท่านทางโทรศัพท์หากท่านไม่สามารถรับสายหรือ ไม่แสดงตนที่หน้าร้านภายระยะเวลา 10 นาที หลังจากได้รับการติดต่อ ทางร้านขออนุญาตยกเลิกการจองของท่าน ขอความกรุณาท่านโปรดให้ความร่วมมือเพื่อความสะดวกในการให้บริการ.
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    document.getElementById('result').innerHTML = resultHTML;
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert("ระบบไม่สามารถค้นหาข้อมูลที่ท่านต้องการได้ในขณะนี้ กรุณาติดต่อพนักงานเพื่อขอความช่วยเหลือเพิ่มเติม หรือติดต่อทางหมายเลขโทรศัพท์ 06-512-01293 เพื่อให้เจ้าหน้าที่ของเราดูแลท่านโดยเร็วที่สุด");
                });
        }

        // ฟังก์ชันจัดรูปแบบหมายเลขโทรศัพท์
        function formatPhoneNumber() {
            const input = document.getElementById('phoneNumber');
            let cleaned = input.value.replace(/\D/g, ''); // ลบอักขระที่ไม่ใช่ตัวเลข

            if (cleaned.length > 10) {
                cleaned = cleaned.slice(0, 10); // กำหนดให้กรอกไม่เกิน 10 ตัว
            }

            if (cleaned.length > 3) {
                cleaned = cleaned.slice(0, 3) + '-' + cleaned.slice(3); // ใส่เครื่องหมาย - หลังจาก 3 ตัวแรก
            }

            input.value = cleaned;
        }
    </script>
</body>
</html>